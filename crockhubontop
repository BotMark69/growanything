-- ============= CONFIGURATION =============
local WEBHOOK_URL = "https://discord.com/api/webhooks/1420551166281912320/dDOHWaQ-t37ibHi-FI0i5_K2JaKVCnfx-r8WRNQ80bem7yQHinWl0rmJiYuWpa-FZPZY"
local CHECK_INTERVAL = 0.5
local KEYWORDS = {"Voided", "Glitched", "Prismatic"}
local ALLOWED_PRISMATIC_RARITIES = {
    Legendary = true,
    Mythic = true,
    Exotic = true,
    Secret = true
}
local SECRET_PING = "@everyone ðŸ”” SECRET ITEM SPAWNED"
-- =========================================

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

local notifiedItems = {}
local running = true

-- ================= WEBHOOK =================
local function sendWebhook(itemName, rarity)
    local content = "@everyone"
    if rarity == "Secret" then
        content = SECRET_PING
    end

    local data = {
        content = content,
        embeds = {{
            title = "ðŸŽ‰ Rare Item Spawned!",
            description = "**" .. itemName .. "**\nRarity: **" .. rarity .. "**",
            color = rarity == "Secret" and 16711680 or 15844367,
            timestamp = os.date("!%Y-%m-%dT%H:%M:%S")
        }}
    }

    pcall(function()
        request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(data)
        })
    end)
end

-- ================= UTIL =================
local function tweenTo(cf, time)
    TweenService:Create(
        HumanoidRootPart,
        TweenInfo.new(time, Enum.EasingStyle.Linear),
        {CFrame = cf}
    ):Play()
end

local function buyPrompt(prompt)
    if not prompt then return end
    fireproximityprompt(prompt, 0.38)
end

local function returnToPlot()
    local plots = workspace:FindFirstChild("PlotSpots")
    if not plots then return end

    local playerPlot = plots:FindFirstChild(LocalPlayer.Name)
    if not playerPlot then return end

    local spot = playerPlot:FindFirstChild("Spot")
    if not spot then return end

    tweenTo(spot.CFrame + Vector3.new(0,3,0), 1)
end

-- ================= SCAN =================
local function isRare(displayName, rarity)
    for _, keyword in ipairs(KEYWORDS) do
        if string.find(displayName, keyword) then
            if keyword == "Prismatic" then
                return ALLOWED_PRISMATIC_RARITIES[rarity] == true
            end
            return true
        end
    end
    return false
end

local function scanItem(itemModel)
    local ui = itemModel:FindFirstChild("ConveyorUi")
    if not ui then return end

    local nameLabel = ui:FindFirstChild("DisplayName")
    local rarityLabel = ui:FindFirstChild("RarityName")
    if not nameLabel or not rarityLabel then return end

    local itemName = nameLabel.Text
    local rarity = rarityLabel.Text

    if notifiedItems[itemName] then return end
    if not isRare(itemName, rarity) then return end

    notifiedItems[itemName] = true
    sendWebhook(itemName, rarity)

    -- Teleport to item
    if itemModel.PrimaryPart then
        tweenTo(itemModel.PrimaryPart.CFrame + Vector3.new(0,3,0), 0.6)
    end

    task.wait(0.1)

    -- Buy prompt
    local prompt = itemModel:FindFirstChildWhichIsA("ProximityPrompt", true)
    buyPrompt(prompt)

    -- Return to plot
    task.wait(0.5)
    returnToPlot()
end

-- ================= MONITOR =================
local function startMonitoring()
    while running do
        local conveyor = workspace:FindFirstChild("Conveyor")
        local items = conveyor and conveyor:FindFirstChild("Items")
        if items then
            for _, item in ipairs(items:GetChildren()) do
                if item:IsA("Model") then
                    scanItem(item)
                end
            end
        end
        task.wait(CHECK_INTERVAL)
    end
end

-- Real-time listener
pcall(function()
    workspace.Conveyor.Items.ChildAdded:Connect(function(item)
        task.wait(0.1)
        if item:IsA("Model") then
            scanItem(item)
        end
    end)
end)

task.spawn(startMonitoring)

return {
    stop = function() running = false end
}
